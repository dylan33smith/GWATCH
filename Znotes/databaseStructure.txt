# SONGBIRD Database Structure

## gwatch_db (Main Database)

### users table:
├── user_id (int, auto-increment, primary key)
├── username (varchar(255), unique)
├── password (varchar(88))
├── mail (varchar(255))
├── role (varchar(255))
└── created_at (int)

### module_tracking table:
├── id (int, auto-increment, primary key)
├── name (varchar(100))
├── owner_id (int, foreign key to users.user_id)
├── public (tinyint/boolean)
├── description (longtext, nullable)
└── createdAt (datetime)

### doctrine_migration_versions table:
├── version (varchar(191), primary key)
└── executed_at (datetime, nullable)

## Module Databases (Module_{id})

Each module creates its own database with the following tables:

### chr table:
├── chr (int, primary key)
├── chrname (varchar(255), indexed)
└── len (int)

### chrsupp table:
├── chr (int, primary key)
├── chroff (int)
└── chrlen (int)

### col table:
├── col (int, primary key)
├── test (varchar(255), nullable)
├── refTable (varchar(255))
└── refCol (varchar(255))

### ind table:
├── chr (int, part of composite primary key)
├── nrow (int, part of composite primary key)
└── ind (int, indexed)

### v_ind table:
├── ind (int, part of composite primary key)
├── col (int, part of composite primary key)
└── v_ind (int, indexed)

### r_pval table:
├── v_ind (int, primary key)
└── r_pval (int)

### r_ratio table:
├── v_ind (int, primary key)
└── r_ratio (int)

### pval table:
├── v_ind (int, primary key)
└── pval (float)

### ratio table:
├── v_ind (int, primary key)
└── ratio (float)

### pos table:
├── ind (int, primary key)
└── pos (int, indexed)

### alias table:
├── ind (int, primary key)
└── alias (varchar(255), indexed)

### allele table:
├── ind (int, primary key)
└── allele (varchar(255), indexed)

### maf table:
├── ind (int, primary key)
└── maf (float, indexed)

### radius_ind table:
├── radius_ind (int(2), unsigned, indexed) -- Radius index
├── radius_type (varchar(31), NOT NULL)        -- Radius type
└── radius_val (int(4), unsigned, NOT NULL)    -- Radius value

### top_hits table:
├── bits (int(4), NOT NULL, part of composite primary key) -- Analysis type flags
├── radius_ind (int(2), unsigned, NOT NULL, part of composite primary key) -- Radius index (1,2,3...)
├── v_ind (int(8), unsigned, NOT NULL, part of composite primary key) -- Variant index
├── r_density (int(4), unsigned, NOT NULL)     -- Ranked density
├── r_naive_p (int(4), unsigned, NOT NULL)    -- Ranked naive p-value
├── left_ind (int(8), unsigned, NOT NULL)      -- Left genomic boundary
├── right_ind (int(8), unsigned, NOT NULL)     -- Right genomic boundary
├── left_cnt (int(4), unsigned, NOT NULL)      -- Left count
├── right_cnt (int(4), unsigned, NOT NULL)     -- Right count
├── density (double, nullable)                  -- Density value
├── naive_p (double, nullable)                  -- Naive p-value
├── adj_p (double, nullable)                    -- Adjusted p-value
└── cal_p (double, nullable)                    -- Calibrated p-value

## Notes:
- Module databases follow naming convention: Module_{id} where id is the module_tracking.id
- All tables use appropriate indexes for performance
- Foreign key relationships exist between gwatch_db and module databases
- radius_ind table includes indexes on radius_ind and radius_type for query performance
- top_hits table includes composite primary key on (bits, radius_ind, v_ind) and index on bits for query performance
- No module_id fields needed as each module has its own database
- radius_ind and top_hits tables are created and populated directly by ModuleCreationService during module creation
- All module tables follow the same pattern: create table, parse CSV, insert data
- density_X.csv files must be named with the radius index (e.g., density_7.csv, density_11.csv) - the number is extracted and used as radius_ind for all rows
- adj_p and cal_p fields are set to NULL as they are not provided in the CSV data

----------------------------------------------------------------------------------------------------------------------
- CSV data is parsed and inserted according to:

| Database Table | CSV File    | Database Columns              | CSV Columns | Mapping                               |
| -------------- | ----------- | ----------------------------- | ----------- | ------------------------------------- |
| chr            | chr.csv     | chr, chrname, len             | 1, 2, 3     | chr→1, chrname→2, len→3               |
| chrsupp        | chrsupp.csv | chr, chroff, chrlen           | 1, 2, 3     | chr→1, chroff→2, chrlen→3             |
| col            | col.csv     | col, test, ref.table, ref.col | 1, 2, 3, 4  | col→1, test→2, ref.table→3, ref.col→4 |
| ind            | ind.csv     | chr, nrow, ind                | 1, 2, 3     | chr→1, nrow→2, ind→3                  |
| r_pval         | r_pval.csv  | v_ind, r_pval                 | 1, 2        | v_ind→1, r_pval→2                     |
| r_ratio        | r_ratio.csv | v_ind, r_ratio                | 1, 2        | v_ind→1, r_ratio→2                    |
| v_ind          | v_ind.csv   | ind, col, v_ind               | 1, 2, 3     | ind→1, col→2, v_ind→3                 |
| pos            | row.csv     | ind, pos                      | 1, 3        | ind→1, pos→3                          |
| alias          | row.csv     | ind, alias                    | 1, 2        | ind→1, alias→2                        |
| allele         | row.csv     | ind, allele                   | 1, 4        | ind→1, allele→4                       |
| maf            | row.csv     | ind, maf                      | 1, 5        | ind→1, maf→5                          |
| pval           | val.csv     | v_ind, pval                   | 1, 2        | v_ind→1, pval→2                       |
| ratio          | val.csv     | v_ind, ratio                  | 1, 3        | v_ind→1, pval→2                       |
| radius_ind     | radius_ind.csv | radius_ind, radius_type, radius_val | 1, 2, 3 | radius_ind→1, radius_type→2, radius_val→3 |
| top_hits       | density_X.csv | bits, v_ind, r_density, r_naive_p, left_ind, right_ind, left_cnt, right_cnt, density, naive_p | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 | bits→1, v_ind→2, r_density→3, r_naive_p→4, left_ind→5, right_ind→6, left_cnt→7, right_cnt→8, density→9, naive_p→10, radius_ind→extracted from filename (e.g., density_7.csv → 7), adj_p→NULL, cal_p→NULL |
----------------------------------------------------------------------------------------------------------------------
